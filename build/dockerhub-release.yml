name: $(Image.Version)

trigger: none

variables:
  - name: 'Image.Name'
    value: 'arcusazure/arcus-event-grid-proxy'
  - name: 'Image.TaggedName'
    value: '$(Image.Name):$(Image.Version)'
  # variable 'Image.Version' is set as queue-time variable in azure devops.
  # variable 'Image.MajorMinorVersion' is set during the first powershell step 'Determine'{major}.{minor} version'

stages:
  - stage: 'Docker'
    jobs:
      - job: 'Docker'
        pool:
          vmImage: 'ubuntu-16.04'
        steps:
          - powershell: |
              Write-Host "Determining '{major}.{minor}' for '$(Image.Version)'"

              $index = "$(Image.Version)".IndexOf(".", 2);

              $majorMinorVersion = "$(Image.Version)".Substring(0, $index);

              Write-Host "Found version '$majorMinorVersion'"
              Write-Output ("##vso[task.setvariable variable=Image.MajorMinorVersion;]$majorMinorVersion")
            displayName: "Determine '{major}.{minor}' version"
          - task: Docker@2
            displayName: 'Build image'
            inputs:
              containerRegistry: 'Arcus Azure - Docker Hub'
              command: build
              Dockerfile: src/Arcus.EventGrid.Proxy.Api/Dockerfile
              buildContext: src
              tags: '$(Image.Name):$(Image.MajorMinorVersion)'
          - task: GitHubRelease@0
            displayName: 'Create GitHub release'
            inputs:
              gitHubConnection: 'GitHub (arcus-automation - OAuth)'
              repositoryName: 'arcus-azure/arcus.eventgrid.proxy'
              tagSource: manual
              tag: 'v$(Image.Version)'
              title: 'v$(Image.Version)'
              releaseNotesSource: input
              releaseNotes: |
                Deploy new version via Docker:
                ```shell
                docker run -d -p 88:80 --name arcus $(Image.Name):$(Image.Version)
                ```

                More information can be found on [Docker Hub](https://hub.docker.com/r/$(Image.Name))
          - task: Docker@2
            displayName: "Push '{major}.{minor}.{patch}' to Docker Hub"
            inputs:
              containerRegistry: 'Arcus Azure - Docker Hub'
              command: push
              tags: '$(Build.Repository.Name):$(Build.BuildId)'
          - task: Docker@2
            displayName: "Push '{major}.{minor}' to Docker Hub"
            inputs:
              containerRegistry: 'Arcus Azure - Docker Hub'
              command: push
              tags: '$(Image.Name):$(Image.MajorMinorVersion)'
          - task: Docker@2
            displayName: "Push 'latest' to Docker Hub"
            inputs:
              containerRegistry: 'Arcus Azure - Docker Hub'
              command: push
              tags: '$(Build.Repository.Name):$(Build.BuildId)'
